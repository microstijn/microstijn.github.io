<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/poole_hyde.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/assets/favicon.png"> <title>The road to deconvolution</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <h1><a href="/">Stijn Hendrik Peeters</a></h1> <p class=lead >(micro)biology</p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/">Home</a> <a class="sidebar-nav-item " href="/menu1/">Genome architecture</a> <a class="sidebar-nav-item active" href="/menu2/">Convolution/Deconvolution</a> <a class="sidebar-nav-item " href="/menu3/">Tags</a> </nav> <p>&copy; Stijn H. Peeters.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=the_road_to_deconvolution ><a href="#the_road_to_deconvolution" class=header-anchor >The road to deconvolution</a></h1> <div class=franklin-toc ><ol><li><a href="#convolution">Convolution</a><li><a href="#deconvolution">Deconvolution</a></ol></div> <h2 id=convolution ><a href="#convolution" class=header-anchor >Convolution</a></h2> <p>The goal is to understand and write a deconvolution program. Deconvolution is used for many applications, but main one I am interested in is high resolution microscopy. Before we can understand de-convolution, it would be prudent to first understand convolution.</p> <p>In our case, convolution is the averaging of each pixel based on the surrounding pixels and a &quot;kernel&quot;: a transformative matrix that allocated weights to each pixel.</p> <pre><code class="julia hljs">kernel = [
    a b c;
    d e f;
    g h i
]</code></pre> <p>This kernel matrix tends to be small, and at least smaller than the original image. A 3x3 kernel means the image can only start being transformed at <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">[3,3]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span></span></span></span>, as <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >[</mo><mn>1</mn><mo>:</mo><mn>2</mn><mo separator=true >,</mo><mn>1</mn><mo>:</mo><mn>2</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">[1:2, 1:2]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >1</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.1944em;"></span><span class=mord >2</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >2</span><span class=mclose >]</span></span></span></span> &#40;and all other edge pixels&#41; do not have the required neigours to apply the transformation. There are ways around it, by padding the original matrix with fake data, but I won&#39;t bother.</p> <pre><code class="julia hljs">image = [
    [<span class=hljs-number >1</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >1</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >1</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >1</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >1</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >1</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >2</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >2</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >2</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >2</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >2</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >2</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >3</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >3</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >3</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >3</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >3</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >3</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >4</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >4</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >4</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >4</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >4</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >4</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >5</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >5</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >5</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >5</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >5</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >5</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >6</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >6</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >6</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >6</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >6</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >6</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >7</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >7</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >7</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >7</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >7</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >7</span>,<span class=hljs-number >6</span>];
    [<span class=hljs-number >8</span>,<span class=hljs-number >1</span>] [<span class=hljs-number >8</span>,<span class=hljs-number >2</span>] [<span class=hljs-number >8</span>,<span class=hljs-number >3</span>] [<span class=hljs-number >8</span>,<span class=hljs-number >4</span>] [<span class=hljs-number >8</span>,<span class=hljs-number >5</span>] [<span class=hljs-number >8</span>,<span class=hljs-number >6</span>];
]</code></pre> <p>When the kernel is placed at <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">[3,3]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span></span></span></span>, the value of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">[3,3]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span></span></span></span> becomes</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>a</mi><mo stretchy=false >[</mo><mn>1</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>+</mo><mi>b</mi><mo stretchy=false >[</mo><mn>1</mn><mo separator=true >,</mo><mn>2</mn><mo stretchy=false >]</mo><mo>+</mo><mi>c</mi><mo stretchy=false >[</mo><mn>1</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo><mo>+</mo><mi>d</mi><mo stretchy=false >[</mo><mn>2</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>+</mo><mi>e</mi><mo stretchy=false >[</mo><mn>2</mn><mo separator=true >,</mo><mn>2</mn><mo stretchy=false >]</mo><mo>+</mo><mi>f</mi><mo stretchy=false >[</mo><mn>2</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo><mo>+</mo><mi>g</mi><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>+</mo><mi>h</mi><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>2</mn><mo stretchy=false >]</mo><mo>+</mo><mi>i</mi><mo stretchy=false >[</mo><mn>3</mn><mo separator=true >,</mo><mn>3</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">a[1,1] + b[1,2] + c[1,3] + d[2,1] + e[2,2] + f[2,3] + g[3,1] + h[3,2] + i[3,3]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class=mopen >[</span><span class=mord >1</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class=mopen >[</span><span class=mord >1</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >2</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class=mopen >[</span><span class=mord >1</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class=mopen >[</span><span class=mord >2</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class=mopen >[</span><span class=mord >2</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >2</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mopen >[</span><span class=mord >2</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >2</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class=mopen >[</span><span class=mord >3</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >3</span><span class=mclose >]</span></span></span></span></span> <p>the kernel then trecks across all values, and each is transformed as above. That leads us to the convolve function:</p> <pre><code class="julia hljs"><span class=hljs-comment ># where A = image 2D array and K = kernel.</span>
convolve(A, K) = 
        <span class=hljs-keyword >begin</span>
            <span class=hljs-comment ># initilize array</span>
            C = []

            <span class=hljs-comment ># extract dimentions from A and K</span>
            size_A = size(A)
            size_filter = size(K)
            A_rows = size_A[<span class=hljs-number >1</span>]
            A_cols = size_A[<span class=hljs-number >2</span>]
            window_row = size_filter[<span class=hljs-number >1</span>]
            window_col = size_filter[<span class=hljs-number >2</span>]

            <span class=hljs-comment ># kernel window is uneven. Kenel of dims = 5 would start [3,3] and have [3-2, 3-2] as upper left value. </span>
            row_mid = convert(<span class=hljs-built_in >Int8</span>,sum(<span class=hljs-number >1</span>:window_row) / window_row)
            col_mid = convert(<span class=hljs-built_in >Int8</span>,sum(<span class=hljs-number >1</span>:window_col) / window_col)
            row_one_off = row_mid - <span class=hljs-number >1</span>
            col_one_off = col_mid - <span class=hljs-number >1</span>

            <span class=hljs-comment ># main functional part, zooms across each pixel of each columna and row</span>
            <span class=hljs-comment ># extracts the region of interest &quot;the window&quot; and applies the matrix multiplication.</span>
            <span class=hljs-keyword >for</span> col <span class=hljs-keyword >in</span> col_mid:(A_cols - row_one_off)
                <span class=hljs-keyword >for</span> row <span class=hljs-keyword >in</span> row_mid:(A_rows - row_one_off)
                    window_row_begin = row - row_one_off
                    window_col_begin = col - col_one_off
                    window_row_end = (window_row_begin + window_row - <span class=hljs-number >1</span>)
                    window_col_end = (window_col_begin + window_col - <span class=hljs-number >1</span>)
                    push!(C, sum(sum(A[window_row_begin:window_row_end, window_col_begin:window_col_end] .* K)))
                <span class=hljs-keyword >end</span>
            <span class=hljs-keyword >end</span>

            <span class=hljs-comment ># give array 2 dimentions and push to C</span>
            new_dims = (A_rows - (<span class=hljs-number >2</span>*row_one_off), A_cols - (<span class=hljs-number >2</span>*col_one_off))
            C = reshape(C, new_dims)
        <span class=hljs-keyword >end</span></code></pre> <p>Now that we have a general function defined, we can see it in action:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Images
<span class=hljs-keyword >using</span> TestImages
<span class=hljs-keyword >using</span> CairoMakie

A = testimage(<span class=hljs-string >&quot;fabio_gray_256&quot;</span>);
A = real.(A);

K = [
    -<span class=hljs-number >0</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
    -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
    -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> <span class=hljs-number >25</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
    -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
    -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
    ]

B = convolve(A, K)

<span class=hljs-comment ># figure part</span>
B = B[<span class=hljs-keyword >end</span>:-<span class=hljs-number >1</span>:<span class=hljs-number >1</span>,<span class=hljs-keyword >end</span>:-<span class=hljs-number >1</span>:<span class=hljs-number >1</span>]
A = A[<span class=hljs-keyword >end</span>:-<span class=hljs-number >1</span>:<span class=hljs-number >1</span>,<span class=hljs-keyword >end</span>:-<span class=hljs-number >1</span>:<span class=hljs-number >1</span>]

fig = Figure()

a_ax = CairoMakie.Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>], title = <span class=hljs-string >&quot;Orginal&quot;</span>, aspect = <span class=hljs-number >1</span>)
b_ax = CairoMakie.Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >2</span>], title = <span class=hljs-string >&quot;Filter applied&quot;</span>,aspect = <span class=hljs-number >1</span>)

hidedecorations!(a_ax)
hidedecorations!(b_ax)

heatmap!(a_ax, A&#x27;, colormap = :grays)
heatmap!(b_ax, B&#x27;, colormap = :grays)

fig</code></pre> <img src="/assets/menu2/code/fig.png" alt=""> <p>This is just a simple 2D variant, but should be easy to scale to 3D.</p> <h2 id=deconvolution ><a href="#deconvolution" class=header-anchor >Deconvolution</a></h2> <p>Deconvolution is convolution, but the other way. We have the transformed headshot and the kernel, and we want to go back to the original data. This is what is used in </p> <div class=page-foot > <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Stijn H. Peeters. Last modified: April 14, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div>